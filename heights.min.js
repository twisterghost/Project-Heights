function step(){for(var e=0;e<objects.length;e++){try{objects[e].step();objects[e].drawObj()}catch(t){if(debugMode){console.log(t)}}}setTranslation();setViewScale();checkCollisions();getCanvas().drawLayers()}function start(){if(gameCanvas===null){gameCanvas=$("canvas")}viewWidth=getCanvas().width();viewHeight=getCanvas().height();viewWidthCurrent=viewWidth;viewHeightCurrent=viewHeight;setUpListeners()}function runSteps(){if(running){clearInterval(runIntervalID)}runIntervalID=setInterval(step,1e3/fps);running=true}function pauseSteps(){clearInterval(runIntervalID)}function setUpListeners(){getCanvas().click(handleInputs);$(document).keydown(handleInputs);$(document).keyup(handleInputs)}function setFPS(e){fps=e;runSteps()}function setCanvas(e){gameCanvas=e}function getCanvas(){return gameCanvas}function instanceArrayPosition(e){for(var t=0;t<objects.length;t++){if(objects[t]==e){return t}}return-1}function handleInputs(e){if(e.originalEvent.type=="keydown"){keyStatus[getKeyPressed(e)]=true}else if(e.originalEvent.type=="keyup"){keyStatus[getKeyPressed(e)]=false}for(var t=0;t<inputObjects.length;t++){inputObjects[t].handleInput(e)}}function inputHook(e){inputObjects.push(e)}function inputUnhook(e){for(var t=0;t<inputObjects.length;t++){if(inputObjects[t]==e){inputObjects.splice(t,1)}}}function setTranslation(){var e=viewX-viewXCurrent;var t=viewY-viewYCurrent;viewXCurrent=viewX;viewYCurrent=viewY;getCanvas().translateCanvas({translateX:-e,translateY:-t})}function setViewScale(){var e=viewWidthCurrent/viewWidth;var t=viewHeightCurrent/viewHeight;viewHeightCurrent=viewHeight;viewWidthCurrent=viewWidth;getCanvas().scaleCanvas({scaleX:e,scaleY:t,x:viewX,y:viewY})}function debugMode(e){debugModeFlag=e}function collideable(e){collideableObjs.push(e)}function checkCollisions(){collisionWorker.postMessage(JSON.stringify(collideableObjs));collisionWorker.onmessage=function(e){var t=JSON.parse(e.data);var n=getInstanceByID(t[0]);var r=getInstanceByID(t[1]);try{n.onCollision(r)}catch(i){}}}function resource(e){document.write("<script type='text/javascript' src='"+e+"'>"+"</script>")}function varDefault(e,t){return typeof e!=="undefined"?e:t}function getUniqueID(){return instanceID++}function convertProperty(e,t,n){if(e.hasOwnProperty(t)){e[n]=e[t];delete e[t]}return e}function createInstance(e,t,n,r){r=varDefault(r,0);var i=new n(e,t,instanceID,r);instanceID++;objects.push(i);return i}function destroyInstance(e){var t=instanceArrayPosition(e);var n=objects.splice(t,1);collideableObjs.splice(collideableObjs.indexOf(e),1);try{n[0].destroy()}catch(r){}delete e}function getInstanceByID(e){for(var t=0;t<objects.length;t++){if(objects[t].id==e){return objects[t]}}return null}function collisionInstance(e,t){return e.x<t.x+t.width&&e.x+e.width>t.x&&e.y<t.y+t.height&&e.y+e.height>t.y}function collisionObject(e,t){var n=getObjectsOfType(t);for(var r=0;r<n.length;r++){if(n[r]!=e){if(collisionInstance(e,n[r])){return n[r]}}}return null}function collisionPoint(e,t,n){return t>=e.x&&t<=e.x+e.width&&n>=e.y&&n<=e.y+e.height}function getObjectsOfType(e){var t=[];for(var n=0;n<objects.length;n++){if(objects[n]instanceof e){t.push(objects[n])}}return t}function instanceExists(e){for(var t=0;t<objects.length;t++){if(objects[t]instanceof e){return objects[t]}}return false}function instanceDistance(e,t){return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))}function getKeyCode(e){return e.keyCode}function getKeyPressed(e){var t=String.fromCharCode(e.keyCode);if(charNames.hasOwnProperty(t)){t=charNames[t]}if(charNames.hasOwnProperty(e.keyCode.toString())){t=charNames[e.keyCode.toString()]}return t}function keyDown(e){e=e.toUpperCase();if(keyStatus.hasOwnProperty(e)){return keyStatus[e]}return false}function boundInstance(e,t,n,r,i){if(e.x>r){e.x=r}if(e.x<t){e.x=t}if(e.y>i){e.y=i}if(e.y<n){e.y=n}}var objects=[];var collideableObjs=[];var instanceID=0;var fps=60;var running=false;var runIntervalID=-1;var gameCanvas;var inputObjects=[];var sounds=[];var debugModeFlag=false;var collisionWorker=new Worker("workers/heights-collisions.js");var viewX=0;var viewY=0;var viewXCurrent=0;var viewYCurrent=0;var viewWidth=0;var viewHeight=0;var viewWidthCurrent=0;var viewHeightCurrent=0;var charNames={"&":"UP","(":"DOWN","%":"LEFT","'":"RIGHT"," ":"SPACE",17:"CTRL",18:"ALT",16:"SHIFT",20:"CAPS",9:"TAB"};var keyStatus={};var Sound=function(e){this.mimeType="";var t='<audio><source src="'+e+'" type="'+this.mimeType+'"></audio>';this.audioElement=$(t);$("body").append(this.audioElement);this.audioElement[0].load();sounds.push(this)};Sound.prototype.play=function(){this.audioElement[0].play()};Sound.prototype.pause=function(){this.audioElement[0].pause()};Sound.prototype.loop=function(){this.audioElement[0].loop=true;this.audioElement[0].play()};Sound.prototype.reset=function(){this.audioElement[0].currentTime=0};Sound.prototype.stop=function(){this.audioElement[0].pause();this.audioElement[0].currentTime=0};Sound.prototype.unload=function(){this.audioElement.remove()};Sound.prototype.getTime=function(){return this.audioElement[0].currentTime};Sound.prototype.getProperty=function(e){return this.audioElement[0][e]};Sound.prototype.setProperty=function(e,t){this.audioElement[0][e]=t};var Draw=function(){this.id=getUniqueID();this.type=Draw.DRAW};Draw.prototype.DRAW=0;Draw.prototype.CIRLCE=1;Draw.prototype.SPRITE=2;Draw.prototype.SPRITESHEET=3;Draw.prototype.RECTANGLE=4;Draw.prototype.LINE=5;Draw.prototype.TEXT=6;Draw.prototype.POLYGON=7;Draw.prototype.circle=function(e){this.x=varDefault(e.x,0);this.y=varDefault(e.y,0);this.rad=varDefault(e.rad,0);this.color=varDefault(e.color,"#000");this.width=varDefault(e.width,1);this.centered=varDefault(e.centered,true);this.updateable=varDefault(e.updateable,true);this.filled=varDefault(e.filled,false);this.type=Draw.CIRCLE;if(this.filled){getCanvas().drawArc({layer:this.updateable,name:this.id.toString(),strokeStyle:this.color,strokeWidth:this.width,fillStyle:this.color,fromCenter:this.centered,x:this.x,y:this.y,radius:this.rad})}else{getCanvas().drawArc({layer:this.updateable,name:this.id.toString(),strokeStyle:this.color,strokeWidth:this.width,fromCenter:this.centered,x:this.x,y:this.y,radius:this.rad})}return this};Draw.prototype.sprite=function(e){this.x=varDefault(e.x,0);this.y=varDefault(e.y,0);this.url=varDefault(e.url,"");this.centered=varDefault(e.centered,false);this.updateable=varDefault(e.updateable,true);this.rotate=varDefault(e.rotate,0);this.type=Draw.SPRITE;getCanvas().drawImage({layer:this.updateable,name:this.id.toString(),source:this.url,x:this.x,y:this.y,rotate:this.rotate,fromCenter:this.centered});return this};Draw.prototype.spriteSheet=function(e){this.x=varDefault(e.x,0);this.y=varDefault(e.y,0);this.cropX=varDefault(e.cropX,0);this.cropY=varDefault(e.cropY,0);this.cropWidth=varDefault(e.cropWidth,32);this.cropHeight=varDefault(e.cropHeight,32);this.url=varDefault(e.url,"");this.centered=varDefault(e.centered,false);this.updateable=varDefault(e.updateable,true);this.type=Draw.SPRITESHEET;getCanvas().drawImage({layer:this.updateable,name:this.id.toString(),source:this.url,x:this.x,y:this.y,sx:this.cropX,sy:this.cropY,sWidth:this.cropWidth,sHeight:this.cropHeight,fromCenter:this.centered,cropFromCenter:false});return this};Draw.prototype.rectangle=function(e){this.x=varDefault(e.x,0);this.y=varDefault(e.y,0);this.width=varDefault(e.width,0);this.height=varDefault(e.height,0);this.filled=varDefault(e.filled,false);this.color=varDefault(e.color,"#000");this.type=Draw.RECTANGLE;this.lineWidth=varDefault(e.lineWidth,1);if(this.filled){getCanvas().drawRect({x:this.x,y:this.y,width:this.width,height:this.height,fillStyle:this.color,strokeStyle:this.color,layer:true,name:this.id.toString(),fromCenter:false})}else{getCanvas().drawRect({x:this.x,y:this.y,width:this.width,height:this.height,strokeStyle:this.color,strokeWidth:this.lineWidth,layer:true,name:this.id.toString(),fromCenter:false})}return this};Draw.prototype.polygon=function(e){this.x=varDefault(e.x,0);this.y=varDefault(e.y,0);this.width=varDefault(e.width,0);this.height=varDefault(e.height,0);this.filled=varDefault(e.filled,false);this.color=varDefault(e.color,"#000");this.type=Draw.POLYGON;this.lineWidth=varDefault(e.lineWidth,1);this.sides=varDefault(e.sides,3);this.centered=varDefault(e.centered,true);this.radius=varDefault(e.radius,10);this.projection=varDefault(e.projection,.5);if(this.filled){getCanvas().drawPolygon({x:this.x,y:this.y,width:this.width,height:this.height,fillStyle:this.color,layer:true,name:this.id.toString(),fromCenter:this.centered,sides:this.sides,radius:this.radius,projection:this.projection})}else{getCanvas().drawPolygon({x:this.x,y:this.y,width:this.width,height:this.height,strokeStyle:this.color,strokeWidth:this.lineWidth,layer:true,name:this.id.toString(),fromCenter:this.centered,sides:this.sides,radius:this.radius,projection:this.projection})}return this};Draw.prototype.text=function(e){this.x=varDefault(e.x,0);this.y=varDefault(e.y,0);this.centered=varDefault(e.centered,false);this.text=varDefault(e.text,"");this.font=varDefault(e.font,"12pt Helvetica");this.color=varDefault(e.color,"#000");this.type=Draw.TEXT;getCanvas().drawText({name:this.id.toString(),layer:true,x:this.x,y:this.y,text:this.text,fillStyle:this.color,font:this.font,fromCenter:this.centered});return this};Draw.prototype.update=function(e){switch(this.type){case Draw.SPRITESHEET:e=convertProperty(e,"cropX","sx");e=convertProperty(e,"cropY","sx");e=convertProperty(e,"cropWidth","sWidth");e=convertProperty(e,"cropHeight","sHeight");e=convertProperty(e,"url","source");e=convertProperty(e,"centered","fromCenter");break;case Draw.CIRCLE:e=convertProperty(e,"color","strokeStyle");e=convertProperty(e,"width","strokeWidth");e=convertProperty(e,"centered","fromCenter");if(this.filled){e=convertProperty(e,"color","fillStyle");e=convertProperty(e,"color","strokeStyle")}else{e=convertProperty(e,"color","strokeStyle")}break;case Draw.SPRITE:e=convertProperty(e,"url","source");e=convertProperty(e,"centered","fromCenter");break;case Draw.RECTANGLE:e=convertProperty(e,"lineWidth","strokeWidth");if(this.filled){e=convertProperty(e,"color","fillStyle")}else{e=convertProperty(e,"color","strokeStyle")}break;case draw.POLYGON:e=convertProperty(e,"lineWidth","strokeWidth");if(this.filled){e=convertProperty(e,"color","fillStyle");e=convertProperty(e,"color","strokeStyle")}else{e=convertProperty(e,"color","strokeStyle")}e=convertProperty(e,"centered","fromCenter");break;case draw.TEXT:e=convertProperty(e,"centered","fromCenter");e=convertProperty(e,"color","fillStyle");e=convertProperty(e,"color","strokeStyle")}getCanvas().setLayer(this.id.toString(),e)};Draw.prototype.undraw=function(){getCanvas().removeLayer(this.id.toString())}
